Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var React=_interopRequireWildcard(_react);var _reactRouter=require('react-router');var _invariant=require('invariant');var _invariant2=_interopRequireDefault(_invariant);var _HistoryUtils=require('./HistoryUtils');var _HistoryUtils2=_interopRequireDefault(_HistoryUtils);var _StackUtils=require('./StackUtils');var _StackUtils2=_interopRequireDefault(_StackUtils);var _RouteUtils=require('./RouteUtils');var _RouteUtils2=_interopRequireDefault(_RouteUtils);var _StateUtils=require('./StateUtils');var _StateUtils2=_interopRequireDefault(_StateUtils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var TabStack=function(_React$Component){_inherits(TabStack,_React$Component);function TabStack(props){_classCallCheck(this,TabStack);var _this=_possibleConstructorReturn(this,(TabStack.__proto__||Object.getPrototypeOf(TabStack)).call(this,props));_initialiseProps.call(_this);var children=props.children,history=props.history;(0,_invariant2.default)(history,'The prop `history` is marked as required in `TabStack`, but its value is `undefined` in TabStack');(0,_invariant2.default)(children||React.Children.count(children)>0,'A <TabStack /> must have child elements');var index=history.index,location=history.location;var entries=history.entries||[location];var tabs=children&&_StackUtils2.default.create(children,props);var navigationState=_StateUtils2.default.initialize(tabs,location,entries,'nodes',undefined,index);(0,_invariant2.default)(navigationState.index!==-1,'There is no route defined for path « %s »',location.pathname);var initialRoute=navigationState.routes[navigationState.index];var historyRootIndex=index;var historyNodes=_defineProperty({},initialRoute.name,{index:0,entries:entries.slice(index)});_this.state={tabs:tabs,navigationState:navigationState,historyRootIndex:historyRootIndex,historyNodes:historyNodes};_this.unlistenHistory=_HistoryUtils2.default.listen(history,_this.onHistoryChange);return _this;}_createClass(TabStack,[{key:'componentWillUnmount',value:function componentWillUnmount(){if(this.unlistenHistory)this.unlistenHistory();}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){var _state=this.state,tabs=_state.tabs,navigationState=_state.navigationState;var nextChildren=nextProps.children,history=nextProps.history;var location=history.location;var entries=history.entries||[location];var nextTabs=_StackUtils2.default.create(nextChildren,nextProps);var nextTab=nextTabs.find(function(tab){return(0,_reactRouter.matchPath)(location.pathname,tab);});var nextRoute=nextTab&&_RouteUtils2.default.create(nextTab,location);if(nextRoute&&!_StackUtils2.default.shallowEqual(tabs,nextTabs)){var nextNavigationState=_StateUtils2.default.initialize(nextTabs,location,entries,'nodes',navigationState,history.index);(0,_invariant2.default)(nextNavigationState.index!==-1,'There is no route defined for path « %s »',location.pathname);this.setState({tabs:nextTabs,navigationState:nextNavigationState});}}},{key:'shouldComponentUpdate',value:function shouldComponentUpdate(nextProps,nextState){return this.state.tabs!==nextState.tabs||this.state.navigationState!==nextState.navigationState;}},{key:'render',value:function render(){return this.props.render({navigationState:this.state.navigationState,tabs:this.state.tabs,onIndexChange:this.onIndexChange,renderTab:this.renderTab});}}]);return TabStack;}(React.Component);TabStack.defaultProps={changeTabMode:'state'};var _initialiseProps=function _initialiseProps(){var _this2=this;this.unlistenHistory=null;this.onHistoryChange=function(history,nextHistory){var location=nextHistory.location;var _state2=_this2.state,navigationState=_state2.navigationState,tabs=_state2.tabs;var routes=navigationState.routes;var currentRoute=routes[navigationState.index];var nextTab=tabs.find(function(tab){return(0,_reactRouter.matchPath)(location.pathname,tab);});if(nextTab){var staleRoute=routes.find(function(route){return route.name===nextTab.path;});var nextRoute=_RouteUtils2.default.create(nextTab,location,staleRoute);_this2.setState(function(prevState){return{navigationState:nextRoute&&!_RouteUtils2.default.equal(currentRoute,nextRoute)?_StateUtils2.default.changeIndex(prevState.navigationState,nextRoute):prevState.navigationState,historyNodes:nextRoute&&'entries'in nextHistory?_HistoryUtils2.default.saveNodes(nextHistory,nextRoute,prevState):prevState.historyNodes};});}};this.onIndexChange=function(arg){var _props=_this2.props,history=_props.history,changeTabMode=_props.changeTabMode;var _state3=_this2.state,tabs=_state3.tabs,navigationState=_state3.navigationState,historyRootIndex=_state3.historyRootIndex;var index=_StateUtils2.default.getRouteIndex(navigationState,arg);var nextRoute=navigationState.routes[index];var nextTab=tabs.find(function(tab){return tab.path===nextRoute.name;});if(nextTab&&index!==navigationState.index){var location=_HistoryUtils2.default.createLocation(history,nextTab);_this2.setState(function(prevState){return{navigationState:changeTabMode==='state'?_StateUtils2.default.changeIndex(navigationState,_RouteUtils2.default.create(nextTab,location,nextRoute)||index):prevState.navigationState,historyNodes:_HistoryUtils2.default.saveNodes(location,nextRoute,prevState)};},function(){if('entries'in history){_HistoryUtils2.default.regenerateFromEntries(history,_this2.state.historyNodes[nextRoute.name],historyRootIndex);}else{_HistoryUtils2.default.regenerateFromLocation(history,location);}});}else{var n=historyRootIndex-history.index;if(n<0){history.go(n);}else if(nextTab){if(typeof nextTab.onReset==='function'){nextTab.onReset();}else if(nextTab.initialPath){history.replace(nextTab.initialPath);}else if(nextTab.path){history.replace(nextTab.path);}}}};this.renderTab=function(route){var lazy=_this2.props.lazy;var historyNodes=_this2.state.historyNodes;if(lazy&&!historyNodes[route.name])return null;var children=React.Children.toArray(_this2.props.children);var child=children.find(function(_ref){var props=_ref.props;return props.path===route.name;});if(!child)return null;return React.cloneElement(child,route);};};exports.default=TabStack;