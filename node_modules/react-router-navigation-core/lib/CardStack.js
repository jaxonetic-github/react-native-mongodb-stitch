Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var React=_interopRequireWildcard(_react);var _reactRouter=require('react-router');var _invariant=require('invariant');var _invariant2=_interopRequireDefault(_invariant);var _HistoryUtils=require('./HistoryUtils');var _HistoryUtils2=_interopRequireDefault(_HistoryUtils);var _StackUtils=require('./StackUtils');var _StackUtils2=_interopRequireDefault(_StackUtils);var _RouteUtils=require('./RouteUtils');var _RouteUtils2=_interopRequireDefault(_RouteUtils);var _StateUtils=require('./StateUtils');var _StateUtils2=_interopRequireDefault(_StateUtils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var CardStack=function(_React$Component){_inherits(CardStack,_React$Component);function CardStack(props){_classCallCheck(this,CardStack);var _this=_possibleConstructorReturn(this,(CardStack.__proto__||Object.getPrototypeOf(CardStack)).call(this,props));_initialiseProps.call(_this);var children=props.children,history=props.history;(0,_invariant2.default)(history,'The prop `history` is marked as required in `CardStack`, but its value is `undefined` in CardStack');(0,_invariant2.default)(children||React.Children.count(children)>0,'A <CardStack /> must have child elements');var location=history.location;var entries=history.entries||[location];var cards=_StackUtils2.default.create(children,props);var key='id-'+Date.now();var navigationState=_StateUtils2.default.initialize(cards,location,entries,'history');(0,_invariant2.default)(navigationState.index!==-1,'There is no route defined for path « %s »',location.pathname);_this.unlistenHistory=_HistoryUtils2.default.listen(history,_this.onHistoryChange);var historyRootIndex=history.index-navigationState.index;_this.state={key:key,cards:cards,navigationState:navigationState,historyRootIndex:historyRootIndex};return _this;}_createClass(CardStack,[{key:'componentDidMount',value:function componentDidMount(){var backHandler=this.props.backHandler;backHandler.addEventListener('hardwareBackPress',this.onNavigateBack);}},{key:'componentWillUnmount',value:function componentWillUnmount(){var backHandler=this.props.backHandler;if(this.unlistenHistory)this.unlistenHistory();backHandler.removeEventListener('hardwareBackPress',this.onNavigateBack);}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){var nextChildren=nextProps.children,history=nextProps.history;var location=history.location;var _state=this.state,cards=_state.cards,historyRootIndex=_state.historyRootIndex,navigationState=_state.navigationState;var nextCards=_StackUtils2.default.create(nextChildren,nextProps);var nextCard=nextCards.find(function(card){return(0,_reactRouter.matchPath)(location.pathname,card);});var nextRoute=nextCard&&_RouteUtils2.default.create(nextCard,location);var isCorrumped=_StateUtils2.default.isCorrumped(navigationState,history,historyRootIndex);if(nextRoute&&nextCards&&(!_StackUtils2.default.shallowEqual(cards,nextCards)||isCorrumped)){var _location=history.location,index=history.index;var entries=history.entries||[_location];var newKey='id-'+Date.now();var nextNavigationState=_StateUtils2.default.initialize(nextCards,_location,entries,'history',navigationState);(0,_invariant2.default)(nextNavigationState.index!==-1,'There is no route defined for path « %s »',_location.pathname);var newHistoryRootIndex=index-nextNavigationState.index;this.setState(function(prevState){return{key:isCorrumped?newKey:prevState.key,cards:nextCards,navigationState:nextNavigationState,historyRootIndex:newHistoryRootIndex};});}}},{key:'shouldComponentUpdate',value:function shouldComponentUpdate(nextProps,nextState){return this.state.cards!==nextState.cards||this.state.navigationState!==nextState.navigationState;}},{key:'render',value:function render(){return this.props.render(_extends({},this.state,{onNavigateBack:this.onNavigateBack,renderCard:this.renderCard}));}}]);return CardStack;}(React.Component);var _initialiseProps=function _initialiseProps(){var _this2=this;this.unlistenHistory=null;this.onHistoryChange=function(history,nextHistory){var index=history.index;var location=nextHistory.location,action=nextHistory.action,nextIndex=nextHistory.index;var _state2=_this2.state,navigationState=_state2.navigationState,cards=_state2.cards;var currentRoute=navigationState.routes[navigationState.index];var nextCard=cards.find(function(card){return(0,_reactRouter.matchPath)(location.pathname,card);});var nextRoute=nextCard&&_RouteUtils2.default.create(nextCard,location);if(nextRoute&&!_RouteUtils2.default.equal(currentRoute,nextRoute)){switch(action){case'PUSH':{_this2.setState(function(prevState){return{navigationState:_StateUtils2.default.push(prevState.navigationState,nextRoute)};});break;}case'POP':{var n=index-nextIndex;_this2.setState(function(prevState){return{navigationState:_StateUtils2.default.pop(prevState.navigationState,n)};});break;}case'REPLACE':{_this2.setState(function(prevState){return{navigationState:_StateUtils2.default.replace(prevState.navigationState,prevState.navigationState.index,nextRoute)};});break;}default:}}};this.onNavigateBack=function(){if(_this2.state.navigationState.index>0){_this2.props.history.goBack();return true;}return false;};this.renderCard=function(route){var children=React.Children.toArray(_this2.props.children);var child=children.find(function(_ref){var props=_ref.props;return props.path===route.name;});if(!child)return null;return React.cloneElement(child,route);};};exports.default=CardStack;